<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZGYSK3Q7WT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-ZGYSK3Q7WT');
    </script>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KQBQ422H');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berta1Clarity</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="AI-powered thinking tool. Break down goals, surface hidden assumptions, and think more clearly.">
    <meta name="theme-color" content="#e8c547">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Berta1Clarity">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0a0b; --bg-surface: #141416; --bg-elevated: #1c1c1f; --bg-hover: #242428;
            --border: #2a2a2f; --border-subtle: #1f1f24;
            --text-primary: #f5f5f4; --text-secondary: #a1a1a6; --text-muted: #636366;
            --accent-clarity: #e8c547; --accent-prerequisite: #7dd3fc; --accent-assumption: #f472b6;
            --accent-handover: #a78bfa; --accent-constraint: #fb923c; --accent-collision: #4ade80;
            --accent-resurrector: #f87171; --accent-inverse: #60a5fa;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-deep); color: var(--text-primary); min-height: 100vh; }
        .app { display: grid; grid-template-columns: 240px 1fr 280px; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { background: var(--bg-surface); border-right: 1px solid var(--border-subtle); padding: 24px 0; display: flex; flex-direction: column; }
        .logo { padding: 0 18px; margin-bottom: 32px; }
        .logo h1 { font-family: 'Instrument Serif', serif; font-size: 20px; font-weight: 400; }
        .logo span { color: var(--accent-clarity); }
        .logo p { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
        .nav-section { margin-bottom: 24px; }
        .nav-title { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); padding: 0 18px; margin-bottom: 8px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 9px 18px; cursor: pointer; border-left: 2px solid transparent; transition: all 0.15s; }
        .nav-item:hover { background: var(--bg-hover); }
        .nav-item.active { background: var(--bg-elevated); border-left-color: var(--accent-clarity); }
        .nav-item .icon { width: 26px; height: 26px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .nav-item[data-mode="prerequisite"] .icon { background: rgba(125,211,252,0.15); color: var(--accent-prerequisite); }
        .nav-item[data-mode="assumption"] .icon { background: rgba(244,114,182,0.15); color: var(--accent-assumption); }
        .nav-item[data-mode="handover"] .icon { background: rgba(167,139,250,0.15); color: var(--accent-handover); }
        .nav-item[data-mode="constraint"] .icon { background: rgba(251,146,60,0.15); color: var(--accent-constraint); }
        .nav-item[data-mode="collision"] .icon { background: rgba(74,222,128,0.15); color: var(--accent-collision); }
        .nav-item[data-mode="resurrector"] .icon { background: rgba(248,113,113,0.15); color: var(--accent-resurrector); }
        .nav-item[data-mode="inverse"] .icon { background: rgba(96,165,250,0.15); color: var(--accent-inverse); }
        .nav-item[data-mode="graph"] .icon { background: rgba(232,197,71,0.15); color: var(--accent-clarity); }
        .nav-item .label { font-size: 12px; color: var(--text-secondary); }
        .nav-item.active .label { color: var(--text-primary); }
        .nav-item .badge { margin-left: auto; font-size: 9px; padding: 2px 5px; background: var(--bg-hover); border-radius: 8px; color: var(--text-muted); }
        .nav-item.pro-tool { opacity: 0.85; }
        .nav-item.pro-tool:hover { opacity: 1; background: linear-gradient(90deg, var(--bg-hover), transparent); }
        .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid var(--border-subtle); }
        .ai-toggle { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-elevated); border-radius: 6px; cursor: pointer; font-size: 11px; color: var(--text-secondary); }
        
        /* Main */
        .main { padding: 32px; overflow-y: auto; max-height: 100vh; }
        .panel { display: none; animation: fadeIn 0.2s ease; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { margin-bottom: 24px; }
        .header h2 { font-family: 'Instrument Serif', serif; font-size: 28px; font-weight: 400; margin-bottom: 4px; }
        .header p { font-size: 13px; color: var(--text-secondary); max-width: 500px; }
        
        /* Right Panel */
        .right { background: var(--bg-surface); border-left: 1px solid var(--border-subtle); padding: 20px 16px; overflow-y: auto; }
        .panel-title { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 14px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
        .stat { background: var(--bg-elevated); border-radius: 6px; padding: 10px; text-align: center; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 20px; }
        .stat-label { font-size: 8px; color: var(--text-muted); text-transform: uppercase; }
        
        /* Cards */
        .card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 18px; margin-bottom: 16px; }
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .card-title { font-size: 12px; font-weight: 500; }
        .card-badge { font-size: 9px; padding: 3px 7px; background: var(--bg-elevated); border-radius: 12px; color: var(--text-muted); }
        
        /* Inputs */
        .input-group { margin-bottom: 14px; }
        .input-label { font-size: 10px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 5px; display: block; }
        .text-input { width: 100%; padding: 10px 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 12px; color: var(--text-primary); }
        .text-input:focus { outline: none; border-color: var(--accent-clarity); }
        .text-input::placeholder { color: var(--text-muted); }
        textarea.text-input { min-height: 80px; resize: vertical; }
        select.text-input { cursor: pointer; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; gap: 5px; padding: 8px 14px; border-radius: 6px; font-family: inherit; font-size: 11px; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; }
        .btn-primary { background: var(--accent-clarity); color: var(--bg-deep); }
        .btn-primary:hover { background: #f0d05a; }
        .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: 5px 8px; }
        .btn-ghost:hover { color: var(--text-primary); }
        
        /* Tree */
        .tree { background: var(--bg-elevated); border-radius: 8px; padding: 14px; min-height: 120px; }
        .tree-node { padding: 8px 12px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 5px; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .tree-node.l1 { margin-left: 20px; }
        .tree-node.l2 { margin-left: 40px; }
        .tree-node.l3 { margin-left: 60px; }
        .tree-node:hover { border-color: var(--accent-prerequisite); }
        .tree-status { width: 7px; height: 7px; border-radius: 50%; background: var(--text-muted); cursor: pointer; flex-shrink: 0; }
        .tree-status.complete { background: var(--accent-collision); }
        .tree-status.blocked { background: var(--accent-resurrector); }
        .tree-status.in-progress { background: var(--accent-constraint); }
        .tree-text { flex: 1; font-size: 12px; }
        .tree-actions { display: flex; gap: 3px; opacity: 0; transition: opacity 0.15s; }
        .tree-node:hover .tree-actions { opacity: 1; }
        .tree-btn { width: 22px; height: 22px; border-radius: 4px; border: none; background: var(--bg-elevated); color: var(--text-muted); cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; }
        .tree-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .tree-tags { display: flex; gap: 4px; margin-top: 5px; flex-wrap: wrap; }
        .tree-tag { font-size: 8px; padding: 2px 5px; border-radius: 3px; }
        .tree-tag.assumption { background: rgba(244,114,182,0.15); color: var(--accent-assumption); }
        .tree-tag.antigoal { background: rgba(96,165,250,0.15); color: var(--accent-inverse); }
        
        /* List Items */
        .list-item { display: flex; gap: 10px; padding: 12px; background: var(--bg-elevated); border-radius: 6px; margin-bottom: 6px; }
        .list-item:hover { background: var(--bg-hover); }
        .list-icon { width: 24px; height: 24px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; }
        .list-item.assumption .list-icon { background: rgba(244,114,182,0.15); color: var(--accent-assumption); }
        .list-item.fragment .list-icon { background: rgba(248,113,113,0.15); color: var(--accent-resurrector); }
        .list-item.antigoal .list-icon { background: rgba(96,165,250,0.15); color: var(--accent-inverse); }
        .list-item.knowledge .list-icon { background: rgba(167,139,250,0.15); color: var(--accent-handover); }
        .list-item.collision .list-icon { background: rgba(74,222,128,0.15); color: var(--accent-collision); }
        .list-content { flex: 1; min-width: 0; }
        .list-text { font-size: 12px; margin-bottom: 3px; line-height: 1.4; }
        .list-meta { font-size: 9px; color: var(--text-muted); display: flex; gap: 8px; }
        .list-links { margin-top: 6px; display: flex; gap: 4px; flex-wrap: wrap; }
        .link-tag { font-size: 8px; padding: 2px 5px; background: var(--bg-surface); border-radius: 3px; color: var(--text-muted); }
        .list-actions { display: flex; gap: 3px; }
        
        /* Constraint */
        .constraint-box { text-align: center; padding: 28px; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border-radius: 12px; margin-bottom: 16px; }
        .constraint-level { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-constraint); margin-bottom: 10px; }
        .constraint-text { font-family: 'Instrument Serif', serif; font-size: 18px; font-style: italic; max-width: 380px; margin: 0 auto 16px; line-height: 1.4; }
        .constraint-timer { font-family: 'JetBrains Mono', monospace; font-size: 32px; color: var(--accent-constraint); margin-bottom: 6px; }
        .constraint-bar { width: 140px; height: 3px; background: var(--border); border-radius: 2px; margin: 0 auto; overflow: hidden; }
        .constraint-fill { height: 100%; background: var(--accent-constraint); transition: width 0.1s linear; }
        .domain-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .domain-btn { padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; text-align: center; cursor: pointer; }
        .domain-btn:hover { border-color: var(--accent-constraint); }
        .domain-icon { font-size: 16px; margin-bottom: 3px; }
        .domain-label { font-size: 10px; color: var(--text-secondary); }
        
        /* Collision */
        .collision-box { display: grid; grid-template-columns: 1fr auto 1fr; gap: 14px; align-items: center; margin-bottom: 16px; }
        .collision-domain { padding: 20px; background: var(--bg-elevated); border-radius: 10px; text-align: center; }
        .collision-label { font-size: 8px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
        .collision-text { font-family: 'Instrument Serif', serif; font-size: 16px; }
        .collision-spark { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-collision), var(--accent-prerequisite)); display: flex; align-items: center; justify-content: center; font-size: 16px; }
        
        /* Interview */
        .interview-q { padding: 16px; background: linear-gradient(135deg, rgba(167,139,250,0.1), transparent); border-radius: 8px; border-left: 3px solid var(--accent-handover); margin-bottom: 14px; }
        .interview-text { font-family: 'Instrument Serif', serif; font-size: 16px; font-style: italic; margin-bottom: 3px; }
        .interview-context { font-size: 10px; color: var(--text-muted); }
        
        /* Empty */
        .empty { text-align: center; padding: 32px 16px; }
        .empty-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--bg-elevated); display: flex; align-items: center; justify-content: center; font-size: 16px; margin: 0 auto 10px; color: var(--text-muted); }
        .empty-title { font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 3px; }
        .empty-text { font-size: 11px; color: var(--text-muted); }
        
        /* Activity Card */
        .activity-card { background: var(--bg-elevated); border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; border-left: 3px solid var(--border); cursor: pointer; }
        .activity-card:hover { background: var(--bg-hover); }
        .activity-card.prerequisite { border-left-color: var(--accent-prerequisite); }
        .activity-card.assumption { border-left-color: var(--accent-assumption); }
        .activity-card.fragment { border-left-color: var(--accent-resurrector); }
        .activity-card.collision { border-left-color: var(--accent-collision); }
        .activity-card.antigoal { border-left-color: var(--accent-inverse); }
        .activity-card.knowledge { border-left-color: var(--accent-handover); }
        .activity-type { font-size: 8px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 2px; }
        .activity-text { font-size: 11px; line-height: 1.3; margin-bottom: 3px; }
        .activity-meta { font-size: 9px; color: var(--text-muted); }
        
        /* Suggestion */
        .suggestion { background: linear-gradient(135deg, rgba(232,197,71,0.1), rgba(232,197,71,0.02)); border: 1px solid rgba(232,197,71,0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .suggestion-title { font-size: 10px; font-weight: 600; color: var(--accent-clarity); margin-bottom: 3px; }
        .suggestion-text { font-size: 11px; color: var(--text-secondary); line-height: 1.3; }
        
        /* Toast */
        .toast-box { position: fixed; bottom: 16px; right: 16px; z-index: 200; }
        .toast { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; margin-top: 6px; display: flex; align-items: center; gap: 8px; animation: slideIn 0.2s ease; max-width: 240px; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: translateX(0); } }
        .toast-icon { width: 20px; height: 20px; border-radius: 4px; background: rgba(232,197,71,0.15); color: var(--accent-clarity); display: flex; align-items: center; justify-content: center; font-size: 9px; }
        .toast-content { flex: 1; }
        .toast-title { font-size: 11px; font-weight: 500; }
        .toast-text { font-size: 10px; color: var(--text-muted); }
        
        @media (max-width: 1000px) { .app { grid-template-columns: 220px 1fr; } .right { display: none; } }
        @media (max-width: 600px) { .app { grid-template-columns: 1fr; } .sidebar { display: none; } .main { padding: 16px; } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* Tour Overlay */
        .tour-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; }
        .tour-overlay.active { display: block; }
        .tour-highlight { position: absolute; box-shadow: 0 0 0 4px var(--accent-clarity), 0 0 30px rgba(232,197,71,0.6); border-radius: 8px; z-index: 1001; pointer-events: none; transition: all 0.3s ease; background: var(--bg-surface); overflow: hidden; }
        .tour-overlay.active ~ .app .sidebar { position: relative; }
        .tour-clone { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1001; }
        .tour-tooltip { position: absolute; background: var(--bg-surface); border: 1px solid var(--accent-clarity); border-radius: 12px; padding: 20px; max-width: 320px; z-index: 1002; animation: tourPop 0.3s ease; }
        @keyframes tourPop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .tour-step { font-size: 10px; color: var(--accent-clarity); font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .tour-title { font-family: 'Instrument Serif', serif; font-size: 18px; margin-bottom: 8px; }
        .tour-text { font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 16px; }
        .tour-nav { display: flex; gap: 8px; justify-content: space-between; }
        .tour-dots { display: flex; gap: 6px; align-items: center; }
        .tour-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .tour-dot.active { background: var(--accent-clarity); }
        .btn-danger { background: rgba(248,113,113,0.15); color: var(--accent-resurrector); border: 1px solid rgba(248,113,113,0.3); }
        .btn-danger:hover { background: rgba(248,113,113,0.25); }

        /* Demo Banner */
        .demo-banner { background: linear-gradient(135deg, rgba(232,197,71,0.15), rgba(232,197,71,0.05)); border: 1px solid rgba(232,197,71,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; }
        .demo-icon { width: 48px; height: 48px; border-radius: 12px; background: rgba(232,197,71,0.2); display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .demo-content { flex: 1; }
        .demo-title { font-family: 'Instrument Serif', serif; font-size: 18px; margin-bottom: 4px; }
        .demo-text { font-size: 12px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQBQ422H"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<div class="app">
    <aside class="sidebar">
        <div class="logo"><h1>Berta1<span>Clarity</span></h1><p>Think once. Build right.</p></div>
        <nav>
            <div class="nav-section">
                <div class="nav-title">Systems</div>
                <div class="nav-item active" data-mode="prerequisite" onclick="switchMode('prerequisite')"><div class="icon">‚¨°</div><span class="label">Prerequisites</span><span class="badge" id="n-prereq">0</span></div>
                <div class="nav-item" data-mode="assumption" onclick="switchMode('assumption')"><div class="icon">‚óá</div><span class="label">Assumptions</span><span class="badge" id="n-assum">0</span></div>
                <div class="nav-item" data-mode="handover" onclick="switchMode('handover')"><div class="icon">‚áÑ</div><span class="label">Handover</span><span class="badge" id="n-know">0</span></div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Creativity</div>
                <div class="nav-item" data-mode="constraint" onclick="switchMode('constraint')"><div class="icon">‚óé</div><span class="label">Constraints</span></div>
                <div class="nav-item" data-mode="collision" onclick="switchMode('collision')"><div class="icon">‚úß</div><span class="label">Collisions</span><span class="badge" id="n-coll">0</span></div>
                <div class="nav-item" data-mode="resurrector" onclick="switchMode('resurrector')"><div class="icon">‚Üª</div><span class="label">Fragments</span><span class="badge" id="n-frag">0</span></div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Hybrid</div>
                <div class="nav-item" data-mode="inverse" onclick="switchMode('inverse')"><div class="icon">‚äò</div><span class="label">Inverse Brief</span><span class="badge" id="n-anti">0</span></div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Overview</div>
                <div class="nav-item" data-mode="graph" onclick="switchMode('graph')"><div class="icon">‚óà</div><span class="label">Clarity Graph</span></div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Output</div>
                <div class="nav-item" data-mode="export" onclick="switchMode('export')"><div class="icon">‚Üì</div><span class="label">Export & Report</span></div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Config</div>
                <div class="nav-item" data-mode="settings" onclick="switchMode('settings')"><div class="icon">‚öô</div><span class="label">AI Settings</span></div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Pro Tools</div>
                <a href="https://berta.one/periscope" target="_blank" class="nav-item pro-tool" style="text-decoration:none" title="Professional Web Crawler - Extract content from any website"><div class="icon" style="background:rgba(125,211,252,0.15);color:#7dd3fc">üî≠</div><span class="label">Berta1Periscope</span><span class="badge" style="background:#7dd3fc;color:#0a0a0b">PRO</span></a>
                <a href="https://berta.one/insight" target="_blank" class="nav-item pro-tool" style="text-decoration:none" title="AI Website Analysis - Deep analysis of crawled sites"><div class="icon" style="background:rgba(167,139,250,0.15);color:#a78bfa">üîç</div><span class="label">Berta1Insight</span><span class="badge" style="background:#a78bfa;color:#0a0a0b">PRO</span></a>
                <a href="https://berta.one/builder" target="_blank" class="nav-item pro-tool" style="text-decoration:none" title="AI Site Generator - Reproduce sites from crawled data"><div class="icon" style="background:rgba(74,222,128,0.15);color:#4ade80">üèóÔ∏è</div><span class="label">Berta1Builder</span><span class="badge" style="background:#4ade80;color:#0a0a0b">PRO</span></a>
            </div>
            <div class="nav-section">
                <div class="nav-title">Help</div>
                <div class="nav-item" data-mode="demo" onclick="switchMode('demo')"><div class="icon">‚ñ∂</div><span class="label">Demo</span></div>
                <div class="nav-item" onclick="startTour()"><div class="icon">?</div><span class="label">Guided Tour</span></div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="ai-toggle" onclick="clearAllData()">üóë Clear All Data</div>
            <a href="https://ko-fi.com/bertaone" target="_blank" style="display:block;text-align:center;margin-top:12px;font-size:11px;color:var(--text-muted);text-decoration:none;">‚òï Support this project</a>
            <div style="text-align:center;margin-top:8px;font-size:10px;color:var(--text-muted);opacity:0.6;">A <a href="https://berta.one" target="_blank" style="color:var(--accent);text-decoration:none;">Berta.one</a> project</div>
        </div>
    </aside>
    
    <main class="main">
        <!-- Prerequisites -->
        <div class="panel active" id="p-prerequisite">
            <div class="header"><h2>Prerequisite Mapper</h2><p>Surface the true foundations through recursive decomposition.</p></div>
            <div class="card">
                <div class="card-head"><span class="card-title">Define Goal</span></div>
                <div class="input-group"><input type="text" class="text-input" id="goal-in" placeholder="e.g., Launch treasury reporting module by Q2"></div>
                <div style="display:flex;gap:6px"><button class="btn btn-primary" onclick="addGoal()">Begin Mapping ‚Üí</button><button class="btn btn-secondary" onclick="aiDecompose()" id="ai-decompose-btn">‚ú® AI Decompose</button></div>
            </div>
            <div id="tree-section" style="display:none">
                <div class="card">
                    <div class="card-head"><span class="card-title">Dependency Tree</span><span class="card-badge" id="tree-depth">Depth: 0</span></div>
                    <div class="tree" id="tree-box"></div>
                </div>
            </div>
        </div>
        
        <!-- Assumptions -->
        <div class="panel" id="p-assumption">
            <div class="header"><h2>Assumption Register</h2><p>Make invisible beliefs explicit.</p></div>
            <div class="card">
                <div class="card-head"><span class="card-title">Log Assumption</span></div>
                <div class="input-group"><textarea class="text-input" id="assum-in" placeholder="e.g., API response time stays under 200ms..."></textarea></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div class="input-group"><label class="input-label">Trigger</label><select class="text-input" id="assum-trigger"><option value="monthly">Monthly</option><option value="event">Event</option><option value="threshold">Threshold</option></select></div>
                    <div class="input-group"><label class="input-label">Link to Prereq</label><select class="text-input" id="assum-link"></select></div>
                </div>
                <div style="display:flex;gap:6px"><button class="btn btn-primary" onclick="addAssumption()">Register</button><button class="btn btn-secondary" onclick="aiSurfaceAssumptions()" id="ai-assum-btn">‚ú® AI Surface Hidden</button></div>
            </div>
            <div class="card"><div class="card-head"><span class="card-title">Active Assumptions</span><span class="card-badge" id="assum-count">0</span></div><div id="assum-list"></div></div>
        </div>
        
        <!-- Handover -->
        <div class="panel" id="p-handover">
            <div class="header"><h2>Handover Machine</h2><p>Extract tacit knowledge before it disappears.</p></div>
            <div class="card">
                <div class="card-head"><span class="card-title">Knowledge Extraction</span><span class="card-badge" id="q-num">Q1</span></div>
                <div class="interview-q"><div class="interview-text" id="q-text">"What do you check first when something goes wrong?"</div><div class="interview-context" id="q-ctx">Captures diagnostic intuition</div></div>
                <div class="input-group"><textarea class="text-input" id="know-in" placeholder="Record the knowledge..."></textarea></div>
                <div class="input-group"><label class="input-label">Link to Prereq</label><select class="text-input" id="know-link"></select></div>
                <div style="display:flex;gap:6px"><button class="btn btn-primary" onclick="saveKnowledge()">Save & Next ‚Üí</button><button class="btn btn-secondary" onclick="aiGenerateQuestions()" id="ai-q-btn">‚ú® AI Questions</button><button class="btn btn-ghost" onclick="nextQ()">Skip</button></div>
            </div>
            <div class="card"><div class="card-head"><span class="card-title">Captured Knowledge</span><span class="card-badge" id="know-count">0</span></div><div id="know-list"></div></div>
        </div>
        
        <!-- Constraints -->
        <div class="panel" id="p-constraint">
            <div class="header"><h2>Constraint Ratchet</h2><p>Tighten until you produce, then release.</p></div>
            <div class="card" id="domain-pick">
                <div class="card-head"><span class="card-title">Select Domain</span></div>
                <div class="domain-grid">
                    <div class="domain-btn" onclick="setDomain('writing')"><div class="domain-icon">‚úé</div><div class="domain-label">Writing</div></div>
                    <div class="domain-btn" onclick="setDomain('design')"><div class="domain-icon">‚óê</div><div class="domain-label">Design</div></div>
                    <div class="domain-btn" onclick="setDomain('code')"><div class="domain-icon">‚ü®‚ü©</div><div class="domain-label">Code</div></div>
                    <div class="domain-btn" onclick="setDomain('problem')"><div class="domain-icon">‚óà</div><div class="domain-label">Problem</div></div>
                    <div class="domain-btn" onclick="setDomain('music')"><div class="domain-icon">‚ô™</div><div class="domain-label">Music</div></div>
                    <div class="domain-btn" onclick="setDomain('business')"><div class="domain-icon">‚ó≠</div><div class="domain-label">Business</div></div>
                </div>
            </div>
            <div id="constraint-active" style="display:none">
                <div class="constraint-box">
                    <div class="constraint-level" id="c-level">Level 5</div>
                    <div class="constraint-text" id="c-text">"Constraint"</div>
                    <div class="constraint-timer" id="c-timer">3:00</div>
                    <div class="constraint-bar"><div class="constraint-fill" id="c-bar"></div></div>
                </div>
                <div class="card">
                    <div class="card-head"><span class="card-title">Your Work</span><span class="card-badge" id="word-ct">0 words</span></div>
                    <div class="input-group"><textarea class="text-input" id="c-output" placeholder="Create..." oninput="updateWords()"></textarea></div>
                    <div class="input-group"><label class="input-label">Use Fragment</label><select class="text-input" id="c-frag"></select></div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn btn-primary" onclick="submitC()">Submit & Release ‚Üí</button><button class="btn btn-secondary" onclick="aiEvaluateWork()" id="ai-eval-btn">‚ú® AI Evaluate</button><button class="btn btn-secondary" onclick="suggestFrag()">Stuck?</button><button class="btn btn-ghost" onclick="resetC()">Reset</button></div>
                    <div id="ai-feedback" style="margin-top:10px;display:none" class="suggestion"></div>
                </div>
            </div>
        </div>
        
        <!-- Collision -->
        <div class="panel" id="p-collision">
            <div class="header"><h2>Collision Engine</h2><p>Original ideas from unexpected combinations.</p></div>
            <div class="card">
                <div class="card-head"><span class="card-title">Your Challenge</span></div>
                <div class="input-group"><textarea class="text-input" id="coll-challenge" placeholder="What are you stuck on?"></textarea></div>
                <div class="input-group"><label class="input-label">Include Fragment</label><select class="text-input" id="coll-frag"></select></div>
                <button class="btn btn-primary" onclick="genCollision()">Generate Collision ‚úß</button>
            </div>
            <div id="coll-result" style="display:none">
                <div class="collision-box">
                    <div class="collision-domain"><div class="collision-label">Your Domain</div><div class="collision-text" id="coll-yours">‚Äî</div></div>
                    <div class="collision-spark">‚ö°</div>
                    <div class="collision-domain"><div class="collision-label">Random Domain</div><div class="collision-text" id="coll-random">‚Äî</div></div>
                </div>
                <div class="card">
                    <div class="card-head"><span class="card-title">Find Connection</span></div>
                    <div class="input-group"><textarea class="text-input" id="coll-conn" placeholder="What connection can you find?"></textarea></div>
                    <div class="input-group"><label class="input-label">Link to Prereq</label><select class="text-input" id="coll-link"></select></div>
                    <div style="display:flex;gap:6px"><button class="btn btn-primary" onclick="saveCollision()">Save</button><button class="btn btn-secondary" onclick="aiFindConnection()" id="ai-coll-btn">‚ú® AI Find Connection</button><button class="btn btn-secondary" onclick="genCollision()">New</button></div>
                </div>
            </div>
            <div class="card"><div class="card-head"><span class="card-title">Collision Library</span><span class="card-badge" id="coll-count">0</span></div><div id="coll-list"></div></div>
        </div>
        
        <!-- Fragments -->
        <div class="panel" id="p-resurrector">
            <div class="header"><h2>Fragment Resurrector</h2><p>Abandoned drafts waiting for their moment.</p></div>
            <div class="card">
                <div class="card-head"><span class="card-title">Archive Fragment</span></div>
                <div class="input-group"><textarea class="text-input" id="frag-in" placeholder="Paste your abandoned draft..."></textarea></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div class="input-group"><label class="input-label">Why started?</label><input type="text" class="text-input" id="frag-start" placeholder="e.g., Excited"></div>
                    <div class="input-group"><label class="input-label">Why stopped?</label><input type="text" class="text-input" id="frag-stop" placeholder="e.g., Got stuck"></div>
                </div>
                <div class="input-group"><label class="input-label">Tags</label><input type="text" class="text-input" id="frag-tags" placeholder="e.g., essay, idea"></div>
                <div style="display:flex;gap:6px"><button class="btn btn-primary" onclick="saveFrag()">Archive</button><button class="btn btn-secondary" onclick="aiAnalyzeFragment()" id="ai-frag-btn">‚ú® AI Analyze & Tag</button></div>
            </div>
            <div class="card"><div class="card-head"><span class="card-title">Your Fragments</span><span class="card-badge" id="frag-count">0</span></div><div id="frag-list"></div></div>
        </div>
        
        <!-- Inverse -->
        <div class="panel" id="p-inverse">
            <div class="header"><h2>Inverse Brief</h2><p>Define what you refuse. The rest is more original.</p></div>
            <div class="card">
                <div class="card-head"><span class="card-title">Add Anti-Goal</span></div>
                <div class="input-group"><label class="input-label">What must NOT happen?</label><div style="display:flex;gap:6px"><input type="text" class="text-input" id="anti-in" placeholder="e.g., Must not require training" style="flex:1"><button class="btn btn-primary" onclick="addAnti()">Add</button><button class="btn btn-secondary" onclick="aiSuggestAntiGoals()" id="ai-anti-btn">‚ú® AI Suggest</button></div></div>
                <div class="input-group"><label class="input-label">Link to Prereq</label><select class="text-input" id="anti-link"></select></div>
            </div>
            <div class="card"><div class="card-head"><span class="card-title">Anti-Goals</span><span class="card-badge" id="anti-count">0</span></div><div id="anti-list"></div></div>
            <div class="card" id="poss-space" style="display:none"><div class="card-head"><span class="card-title">Possibility Space</span><button class="btn btn-secondary" onclick="aiMapPossibilities()" id="ai-poss-btn" style="margin-left:auto">‚ú® AI Map</button></div><div id="poss-content"></div></div>
        </div>
        
        <!-- Graph -->
        <div class="panel" id="p-graph">
            <div class="header"><h2>Clarity Graph</h2><p>See everything connected.</p></div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px">
                <div class="stat"><div class="stat-val" id="g-prereq">0</div><div class="stat-label">Prerequisites</div></div>
                <div class="stat"><div class="stat-val" id="g-assum">0</div><div class="stat-label">Assumptions</div></div>
                <div class="stat"><div class="stat-val" id="g-frag">0</div><div class="stat-label">Fragments</div></div>
                <div class="stat"><div class="stat-val" id="g-conn">0</div><div class="stat-label">Connections</div></div>
            </div>
            <div class="card"><div class="card-head"><span class="card-title">All Connections</span></div><div id="conn-list"></div></div>
        </div>

        <!-- Demo -->
        <div class="panel" id="p-demo">
            <div class="header"><h2>Demo & Examples</h2><p>See what Berta1Clarity can do for your thinking.</p></div>

            <div class="demo-banner">
                <div class="demo-icon">üöÄ</div>
                <div class="demo-content">
                    <div class="demo-title">Try the Interactive Demo</div>
                    <div class="demo-text">Load sample data to explore all features without starting from scratch.</div>
                </div>
                <button class="btn btn-primary" onclick="loadDemo()">Load Demo Data</button>
            </div>

            <div class="card">
                <div class="card-head"><span class="card-title">What You Can Do</span></div>
                <div style="display:grid;gap:12px">
                    <div class="list-item" style="cursor:pointer" onclick="switchMode('prerequisite')">
                        <div class="list-icon" style="background:rgba(125,211,252,0.15);color:var(--accent-prerequisite)">‚¨°</div>
                        <div class="list-content">
                            <div class="list-text"><strong>Prerequisites</strong> - Break down goals into dependencies</div>
                            <div class="list-meta">AI decomposes goals into 3-5 things that must be true first</div>
                        </div>
                    </div>
                    <div class="list-item" style="cursor:pointer" onclick="switchMode('assumption')">
                        <div class="list-icon" style="background:rgba(244,114,182,0.15);color:var(--accent-assumption)">‚óá</div>
                        <div class="list-content">
                            <div class="list-text"><strong>Assumptions</strong> - Surface hidden beliefs</div>
                            <div class="list-meta">AI finds assumptions you didn't know you were making</div>
                        </div>
                    </div>
                    <div class="list-item" style="cursor:pointer" onclick="switchMode('handover')">
                        <div class="list-icon" style="background:rgba(167,139,250,0.15);color:var(--accent-handover)">‚áÑ</div>
                        <div class="list-content">
                            <div class="list-text"><strong>Handover</strong> - Extract tacit knowledge</div>
                            <div class="list-meta">AI generates interview questions to capture what's undocumented</div>
                        </div>
                    </div>
                    <div class="list-item" style="cursor:pointer" onclick="switchMode('constraint')">
                        <div class="list-icon" style="background:rgba(251,146,60,0.15);color:var(--accent-constraint)">‚óé</div>
                        <div class="list-content">
                            <div class="list-text"><strong>Constraints</strong> - Creative pressure cooker</div>
                            <div class="list-meta">Timed challenges with AI feedback on your work</div>
                        </div>
                    </div>
                    <div class="list-item" style="cursor:pointer" onclick="switchMode('collision')">
                        <div class="list-icon" style="background:rgba(74,222,128,0.15);color:var(--accent-collision)">‚úß</div>
                        <div class="list-content">
                            <div class="list-text"><strong>Collisions</strong> - Spark original ideas</div>
                            <div class="list-meta">AI finds unexpected connections between unrelated domains</div>
                        </div>
                    </div>
                    <div class="list-item" style="cursor:pointer" onclick="switchMode('resurrector')">
                        <div class="list-icon" style="background:rgba(248,113,113,0.15);color:var(--accent-resurrector)">‚Üª</div>
                        <div class="list-content">
                            <div class="list-text"><strong>Fragments</strong> - Revive abandoned work</div>
                            <div class="list-meta">AI suggests how to continue or repurpose stalled projects</div>
                        </div>
                    </div>
                    <div class="list-item" style="cursor:pointer" onclick="switchMode('inverse')">
                        <div class="list-icon" style="background:rgba(96,165,250,0.15);color:var(--accent-inverse)">‚äò</div>
                        <div class="list-content">
                            <div class="list-text"><strong>Inverse Brief</strong> - Define by exclusion</div>
                            <div class="list-meta">AI maps the possibility space from what you refuse</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-head"><span class="card-title">Quick Start</span></div>
                <div style="font-size:13px;color:var(--text-secondary);line-height:1.6">
                    <p style="margin-bottom:12px"><strong>1.</strong> Start with <strong>Prerequisites</strong> - enter your goal and click "AI Decompose"</p>
                    <p style="margin-bottom:12px"><strong>2.</strong> Go to <strong>Assumptions</strong> - click "AI Surface Hidden" to find blind spots</p>
                    <p style="margin-bottom:12px"><strong>3.</strong> Use <strong>Inverse Brief</strong> to define what must NOT happen</p>
                    <p><strong>4.</strong> Check the <strong>Clarity Graph</strong> to see everything connected</p>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startTour()" style="width:100%">‚ñ∂ Start Guided Tour</button>
        </div>

        <!-- Export -->
        <div class="panel" id="p-export">
            <div class="header"><h2>Export & Report</h2><p>Generate deliverables from your thinking work.</p></div>

            <div class="card">
                <div class="card-head"><span class="card-title">Quick Export</span></div>
                <div style="display:grid;gap:10px">
                    <button class="btn btn-secondary" onclick="exportMarkdown()" style="width:100%;justify-content:center">
                        üìÑ Export to Markdown
                    </button>
                    <button class="btn btn-secondary" onclick="exportJSON()" style="width:100%;justify-content:center">
                        { } Export Raw JSON
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-head"><span class="card-title">‚ú® AI Summary Report</span></div>
                <p style="font-size:12px;color:var(--text-secondary);margin-bottom:14px">
                    Claude analyzes all your work and generates a comprehensive strategic brief with insights, risks, and recommendations.
                </p>
                <button class="btn btn-primary" onclick="generateAISummary()" id="ai-summary-btn" style="width:100%;justify-content:center">
                    ‚ú® Generate AI Summary
                </button>
                <div id="ai-summary-result" style="display:none;margin-top:16px">
                    <div class="card-head"><span class="card-title">Generated Report</span>
                        <button class="btn btn-ghost" onclick="copyAISummary()">Copy</button>
                    </div>
                    <div id="ai-summary-content" style="font-size:12px;line-height:1.6;color:var(--text-secondary);white-space:pre-wrap;max-height:400px;overflow-y:auto"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-head"><span class="card-title">üìä Visual Report</span></div>
                <p style="font-size:12px;color:var(--text-secondary);margin-bottom:14px">
                    Generate a styled, printable report. Opens in a new tab - use your browser's Print ‚Üí Save as PDF.
                </p>
                <button class="btn btn-primary" onclick="generateVisualReport()" style="width:100%;justify-content:center">
                    üìä Generate Visual Report
                </button>
            </div>

            <div class="card" id="export-preview" style="display:none">
                <div class="card-head"><span class="card-title">Preview</span></div>
                <div id="export-preview-content" style="font-size:11px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;white-space:pre-wrap;max-height:300px;overflow-y:auto;background:var(--bg-elevated);padding:12px;border-radius:6px"></div>
            </div>
        </div>

        <!-- Settings -->
        <div class="panel" id="p-settings">
            <div class="header"><h2>AI Settings</h2><p>Configure your AI provider and API keys. Keys are stored locally in your browser.</p></div>

            <div class="card">
                <div class="card-head"><span class="card-title">AI Provider</span></div>
                <div class="input-group">
                    <label class="input-label">Select Provider</label>
                    <select class="text-input" id="ai-provider" onchange="updateProvider(this.value)">
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="openai">OpenAI (GPT)</option>
                        <option value="google">Google (Gemini)</option>
                    </select>
                </div>
                <div id="provider-status" style="margin-top:10px;padding:10px;border-radius:6px;font-size:12px"></div>
            </div>

            <div class="card" id="anthropic-settings">
                <div class="card-head"><span class="card-title">Anthropic (Claude)</span></div>
                <div class="input-group">
                    <label class="input-label">API Key</label>
                    <input type="password" class="text-input" id="anthropic-key" placeholder="sk-ant-..." onchange="saveKey('anthropic')">
                </div>
                <div class="input-group">
                    <label class="input-label">Model</label>
                    <select class="text-input" id="anthropic-model" onchange="saveKey('anthropic')">
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended)</option>
                        <option value="claude-opus-4-20250514">Claude Opus 4 (Most Capable)</option>
                        <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku (Fast & Cheap)</option>
                    </select>
                </div>
                <p style="font-size:11px;color:var(--text-muted)">Get your key at <a href="https://console.anthropic.com/" target="_blank" style="color:var(--accent-clarity)">console.anthropic.com</a></p>
            </div>

            <div class="card" id="openai-settings">
                <div class="card-head"><span class="card-title">OpenAI (GPT)</span></div>
                <div class="input-group">
                    <label class="input-label">API Key</label>
                    <input type="password" class="text-input" id="openai-key" placeholder="sk-..." onchange="saveKey('openai')">
                </div>
                <div class="input-group">
                    <label class="input-label">Model</label>
                    <select class="text-input" id="openai-model" onchange="saveKey('openai')">
                        <option value="gpt-4o">GPT-4o (Recommended)</option>
                        <option value="gpt-4o-mini">GPT-4o Mini (Fast & Cheap)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    </select>
                </div>
                <p style="font-size:11px;color:var(--text-muted)">Get your key at <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--accent-clarity)">platform.openai.com</a></p>
            </div>

            <div class="card" id="google-settings">
                <div class="card-head"><span class="card-title">Google (Gemini)</span></div>
                <div class="input-group">
                    <label class="input-label">API Key</label>
                    <input type="password" class="text-input" id="google-key" placeholder="AIza..." onchange="saveKey('google')">
                </div>
                <div class="input-group">
                    <label class="input-label">Model</label>
                    <select class="text-input" id="google-model" onchange="saveKey('google')">
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Recommended)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast)</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
                    </select>
                </div>
                <p style="font-size:11px;color:var(--text-muted)">Get your key at <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--accent-clarity)">aistudio.google.com</a></p>
            </div>

            <div class="card">
                <div class="card-head"><span class="card-title">Test Connection</span></div>
                <button class="btn btn-primary" onclick="testAIConnection()" id="test-ai-btn" style="width:100%;justify-content:center">
                    üîå Test AI Connection
                </button>
                <div id="test-result" style="margin-top:10px;display:none"></div>
            </div>

            <div class="card" style="background:rgba(74,222,128,0.08);border-color:rgba(74,222,128,0.2)">
                <div class="card-head"><span class="card-title" style="color:#4ade80">üîí Your Keys Are Safe</span></div>
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.6">
                    <p style="margin-bottom:8px"><strong>Local storage only:</strong> Your API keys are stored in your browser's localStorage. They never leave your device except to call the AI provider directly.</p>
                    <p style="margin-bottom:8px"><strong>Direct API calls:</strong> Requests go straight to the official AI provider (Anthropic, OpenAI, or Google). No middleman servers.</p>
                    <p style="margin-bottom:8px"><strong>Privacy:</strong> Your data stays in your browser. API keys are only sent to the AI provider you choose.</p>
                    <p style="margin-bottom:0"><strong>Clear anytime:</strong> Use "Clear All Data" in the sidebar to remove all stored keys and data.</p>
                </div>
            </div>
        </div>
    </main>
    
    <aside class="right">
        <div class="panel-title">Live Connections</div>
        <div class="stats">
            <div class="stat"><div class="stat-val" id="s-nodes">0</div><div class="stat-label">Nodes</div></div>
            <div class="stat"><div class="stat-val" id="s-links">0</div><div class="stat-label">Links</div></div>
        </div>
        <div id="suggestions"></div>
        <div class="panel-title" style="margin-top:16px">Recent Activity</div>
        <div id="activity"></div>
    </aside>
</div>
<div class="toast-box" id="toasts"></div>

<!-- Tour Overlay -->
<div class="tour-overlay" id="tour-overlay" onclick="if(event.target===this)endTour()">
    <div class="tour-highlight" id="tour-highlight"></div>
    <div class="tour-tooltip" id="tour-tooltip">
        <div class="tour-step" id="tour-step-num">Step 1 of 8</div>
        <div class="tour-title" id="tour-title">Welcome</div>
        <div class="tour-text" id="tour-text">Tour content</div>
        <div class="tour-nav">
            <div class="tour-dots" id="tour-dots"></div>
            <div style="display:flex;gap:6px">
                <button class="btn btn-ghost" onclick="endTour()">Skip</button>
                <button class="btn btn-secondary" onclick="prevTourStep()" id="tour-prev">Back</button>
                <button class="btn btn-primary" onclick="nextTourStep()" id="tour-next">Next</button>
            </div>
        </div>
    </div>
</div>

<script>
// ========== AI PROVIDER CONFIGURATION ==========
const AI_CONFIG = {
    provider: localStorage.getItem('ai_provider') || 'anthropic',
    anthropic: {
        key: localStorage.getItem('anthropic_key') || '',
        model: localStorage.getItem('anthropic_model') || 'claude-sonnet-4-20250514'
    },
    openai: {
        key: localStorage.getItem('openai_key') || '',
        model: localStorage.getItem('openai_model') || 'gpt-4o'
    },
    google: {
        key: localStorage.getItem('google_key') || '',
        model: localStorage.getItem('google_model') || 'gemini-1.5-pro'
    }
};

function saveAIConfig() {
    localStorage.setItem('ai_provider', AI_CONFIG.provider);
    localStorage.setItem('anthropic_key', AI_CONFIG.anthropic.key);
    localStorage.setItem('anthropic_model', AI_CONFIG.anthropic.model);
    localStorage.setItem('openai_key', AI_CONFIG.openai.key);
    localStorage.setItem('openai_model', AI_CONFIG.openai.model);
    localStorage.setItem('google_key', AI_CONFIG.google.key);
    localStorage.setItem('google_model', AI_CONFIG.google.model);
}

async function askClaude(systemPrompt, userPrompt, maxTokens = 1024) {
    const provider = AI_CONFIG.provider;
    const config = AI_CONFIG[provider];

    if (!config.key) {
        toast('API Key Required', 'Go to Settings to add your key');
        switchMode('settings');
        return null;
    }

    try {
        let res, data;

        if (provider === 'anthropic') {
            res = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': config.key,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: config.model,
                    max_tokens: maxTokens,
                    system: systemPrompt,
                    messages: [{ role: 'user', content: userPrompt }]
                })
            });
            if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'Anthropic API error'); }
            data = await res.json();
            return data.content[0].text;
        }

        else if (provider === 'openai') {
            res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.key}`
                },
                body: JSON.stringify({
                    model: config.model,
                    max_tokens: maxTokens,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ]
                })
            });
            if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'OpenAI API error'); }
            data = await res.json();
            return data.choices[0].message.content;
        }

        else if (provider === 'google') {
            res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: systemPrompt + '\n\n' + userPrompt }] }],
                    generationConfig: { maxOutputTokens: maxTokens }
                })
            });
            if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'Google API error'); }
            data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }
    } catch (e) {
        toast('AI Error', e.message);
        return null;
    }
}

const G = {
    prereqs: [], assums: [], knows: [], frags: [], colls: [], antis: [], conns: [],
    id() { return Date.now().toString(36) + Math.random().toString(36).substr(2); },
    link(ft, fi, tt, ti, l='') { const c = {id:this.id(),ft,fi,tt,ti,l,at:new Date()}; this.conns.push(c); this.save(); toast('Connected',ft+' ‚Üí '+tt); update(); return c; },
    linked(t, i) { return this.conns.filter(c=>(c.ft===t&&c.fi===i)||(c.tt===t&&c.ti===i)).map(c=>{ const isF=c.ft===t&&c.fi===i; const lt=isF?c.tt:c.ft; const li=isF?c.ti:c.fi; const item=this[lt+'s']?.find(x=>x.id===li); return {t:lt,item,c}; }).filter(x=>x.item); },
    save() { localStorage.setItem('CE', JSON.stringify({prereqs:this.prereqs,assums:this.assums,knows:this.knows,frags:this.frags,colls:this.colls,antis:this.antis,conns:this.conns})); },
    load() { const s=localStorage.getItem('CE'); if(s) Object.assign(this, JSON.parse(s)); }
};

let mode='prerequisite', timer=null, cLevel=5, qIdx=0;
const Qs=[{q:"What do you check first when something goes wrong?",c:"Diagnostic intuition"},{q:"What would surprise your replacement?",c:"Hidden complexity"},{q:"What's undocumented but everyone knows?",c:"Tribal knowledge"},{q:"When do you break the process?",c:"Practical wisdom"}];
const Cs={writing:["Exactly 25 words. No adjectives.","Only questions.","Every sentence 5 words."],design:["Only circles. 3 colors max.","Typography only.","Black & white only."],code:["Under 10 lines.","No conditionals.","Single function."],problem:["Use what's at arm's reach.","Opposite approach?","Explain to 5-year-old."],music:["Only 3 notes.","8 bars exactly.","Silence as instrument."],business:["Value in 10 words.","No buzzwords.","Anti-pitch."]};
const RDs=["Beekeeping","Submarines","Medieval liturgy","Jazz","Origami","Volcanoes","Playgrounds","Sourdough","Ant colonies","Chess","Folklore","Triage","Bird migration","Bankruptcy law","Perfume"];

document.addEventListener('DOMContentLoaded',()=>{ G.load(); update(); });

function update() { counts(); renderTree(); renderAssums(); renderKnows(); renderFrags(); renderColls(); renderAntis(); renderAct(); renderSugg(); dropdowns(); renderQ(); updatePoss(); if(mode==='graph') renderGraph(); }
function switchMode(m) { document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); document.querySelector(`[data-mode="${m}"]`).classList.add('active'); document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.getElementById('p-'+m).classList.add('active'); mode=m; renderSugg(); if(m==='graph') renderGraph(); }
function counts() { document.getElementById('n-prereq').textContent=G.prereqs.length; document.getElementById('n-assum').textContent=G.assums.length; document.getElementById('n-know').textContent=G.knows.length; document.getElementById('n-frag').textContent=G.frags.length; document.getElementById('n-coll').textContent=G.colls.length; document.getElementById('n-anti').textContent=G.antis.length; document.getElementById('assum-count').textContent=G.assums.length; document.getElementById('know-count').textContent=G.knows.length; document.getElementById('frag-count').textContent=G.frags.length; document.getElementById('coll-count').textContent=G.colls.length; document.getElementById('anti-count').textContent=G.antis.length; const tot=G.prereqs.length+G.assums.length+G.knows.length+G.frags.length+G.colls.length+G.antis.length; document.getElementById('s-nodes').textContent=tot; document.getElementById('s-links').textContent=G.conns.length; }
function dropdowns() { const opts='<option value="">None</option>'+G.prereqs.map(p=>`<option value="${p.id}">${trunc(p.text,30)}</option>`).join(''); ['assum-link','know-link','coll-link','anti-link'].forEach(id=>{const e=document.getElementById(id);if(e)e.innerHTML=opts;}); const fOpts='<option value="">None</option>'+G.frags.map(f=>`<option value="${f.id}">${trunc(f.text,30)}</option>`).join(''); ['c-frag','coll-frag'].forEach(id=>{const e=document.getElementById(id);if(e)e.innerHTML=fOpts;}); }
function trunc(s,n) { return s&&s.length>n?s.slice(0,n)+'...':s||''; }
function timeAgo(d) { const s=Math.floor((new Date()-new Date(d))/1000); if(s<60)return 'now'; const m=Math.floor(s/60); if(m<60)return m+'m'; const h=Math.floor(m/60); if(h<24)return h+'h'; return Math.floor(h/24)+'d'; }
function toast(t,x) { const c=document.getElementById('toasts'); const d=document.createElement('div'); d.className='toast'; d.innerHTML=`<div class="toast-icon">‚óà</div><div class="toast-content"><div class="toast-title">${t}</div>${x?`<div class="toast-text">${x}</div>`:''}</div>`; c.appendChild(d); setTimeout(()=>{d.style.opacity='0';setTimeout(()=>d.remove(),300);},3000); }

// Prerequisites
function addGoal() { const i=document.getElementById('goal-in'); const t=i.value.trim(); if(!t)return; G.prereqs.push({id:G.id(),text:t,level:0,status:'in-progress',pid:null,at:new Date()}); G.save(); i.value=''; document.getElementById('tree-section').style.display='block'; update(); toast('Goal created','Add prerequisites now'); }

async function aiDecompose() {
    const i=document.getElementById('goal-in'); const goal=i.value.trim();
    if(!goal){ toast('Enter a goal',''); return; }
    const btn=document.getElementById('ai-decompose-btn'); btn.disabled=true; btn.textContent='Thinking...';
    const sys=`You are an expert at breaking down goals into prerequisites. For any goal, identify 3-5 things that MUST be true or in place BEFORE the goal can be achieved. Be specific and actionable. Return ONLY a JSON array of strings, no explanation.`;
    const res = await askClaude(sys, `Goal: "${goal}"\n\nWhat must be true first?`);
    btn.disabled=false; btn.textContent='‚ú® AI Decompose';
    if(!res) return;
    try {
        const prereqs = JSON.parse(res.replace(/```json\n?|\n?```/g, ''));
        const rootId = G.id();
        G.prereqs.push({id:rootId,text:goal,level:0,status:'in-progress',pid:null,at:new Date()});
        prereqs.forEach(p => G.prereqs.push({id:G.id(),text:p,level:1,status:'',pid:rootId,at:new Date()}));
        G.save(); i.value=''; document.getElementById('tree-section').style.display='block'; update();
        toast('AI Decomposed', prereqs.length + ' prerequisites found');
    } catch(e) { toast('Parse Error', 'Could not parse AI response'); console.log(res); }
}

async function aiExpandNode(pid) {
    const p = G.prereqs.find(x=>x.id===pid);
    if(!p) return;
    toast('Expanding...', p.text);
    const ctx = G.prereqs.filter(x=>x.level===0).map(x=>x.text).join(', ');
    const sys=`You are an expert at recursive decomposition. Given a prerequisite, identify 2-4 sub-prerequisites that must be true BEFORE this one can be achieved. Be specific. Return ONLY a JSON array of strings.`;
    const res = await askClaude(sys, `Main goal context: ${ctx}\n\nPrerequisite to decompose: "${p.text}"\n\nWhat must be true first?`);
    if(!res) return;
    try {
        const subs = JSON.parse(res.replace(/```json\n?|\n?```/g, ''));
        subs.forEach(s => G.prereqs.push({id:G.id(),text:s,level:p.level+1,status:'',pid:pid,at:new Date()}));
        G.save(); update();
        toast('Expanded', subs.length + ' sub-prerequisites');
    } catch(e) { toast('Parse Error', ''); console.log(res); }
}
function addChild(pid) { const p=G.prereqs.find(x=>x.id===pid); const t=prompt('What must be true first?'); if(t){ G.prereqs.push({id:G.id(),text:t,level:p.level+1,status:'',pid,at:new Date()}); G.save(); update(); } }
function cycleS(id) { const p=G.prereqs.find(x=>x.id===id); const ss=['','in-progress','complete','blocked']; p.status=ss[(ss.indexOf(p.status)+1)%ss.length]; if(p.status==='complete'&&confirm('Add assumption?')) promptAssum(id); G.save(); update(); }
function promptAssum(pid) { const p=G.prereqs.find(x=>x.id===pid); const t=prompt('Assumption underlying "'+trunc(p.text,30)+'"?'); if(t){ const a={id:G.id(),text:t,trigger:'monthly',status:'active',at:new Date()}; G.assums.push(a); G.link('assum',a.id,'prereq',pid,'underlies'); } }
function renderTree() { const box=document.getElementById('tree-box'); const roots=G.prereqs.filter(p=>p.level===0); if(!roots.length){ box.innerHTML='<div class="empty"><div class="empty-icon">‚¨°</div><div class="empty-title">No goals</div></div>'; document.getElementById('tree-section').style.display='none'; return; } document.getElementById('tree-section').style.display='block'; let h=''; roots.forEach(r=>h+=renderNode(r)); box.innerHTML=h; document.getElementById('tree-depth').textContent='Depth: '+Math.max(...G.prereqs.map(p=>p.level)); }
function renderNode(n) { const ch=G.prereqs.filter(p=>p.pid===n.id); const lks=G.linked('prereq',n.id); const tags=lks.map(l=>l.t==='assum'?`<span class="tree-tag assumption">‚óá ${trunc(l.item.text,12)}</span>`:l.t==='anti'?`<span class="tree-tag antigoal">‚äò ${trunc(l.item.text,12)}</span>`:'' ).join(''); let h=`<div class="tree-node l${n.level}"><div class="tree-status ${n.status}" onclick="cycleS('${n.id}')"></div><span class="tree-text">${n.text}</span><div class="tree-actions"><button class="tree-btn" onclick="addChild('${n.id}')" title="Add prereq">+</button><button class="tree-btn" onclick="aiExpandNode('${n.id}')" title="AI expand">‚ú®</button><button class="tree-btn" onclick="promptAssum('${n.id}')" title="Add assumption">‚óá</button><button class="tree-btn" onclick="delPrereq('${n.id}')" title="Delete" style="color:var(--accent-resurrector)">√ó</button></div></div>`; if(tags) h=h.replace('</div></div>',`</div>${tags?`<div class="tree-tags">${tags}</div>`:''}` + '</div>'); ch.forEach(c=>h+=renderNode(c)); return h; }

function delPrereq(id) {
    if(!confirm('Delete this prerequisite and all its children?')) return;
    const delIds = [id];
    const findChildren = (pid) => { G.prereqs.filter(p=>p.pid===pid).forEach(c=>{ delIds.push(c.id); findChildren(c.id); }); };
    findChildren(id);
    G.prereqs = G.prereqs.filter(p => !delIds.includes(p.id));
    G.conns = G.conns.filter(c => !delIds.includes(c.fi) && !delIds.includes(c.ti));
    G.save(); update(); toast('Deleted', 'Prerequisite removed');
}

// Assumptions
function addAssumption() { const t=document.getElementById('assum-in').value.trim(); if(!t)return; const tr=document.getElementById('assum-trigger').value; const lk=document.getElementById('assum-link').value; const a={id:G.id(),text:t,trigger:tr,status:'active',at:new Date()}; G.assums.push(a); if(lk) G.link('assum',a.id,'prereq',lk,'underlies'); G.save(); document.getElementById('assum-in').value=''; update(); toast('Assumption added',lk?'Linked':''); }

async function aiSurfaceAssumptions() {
    if(!G.prereqs.length){ toast('Add prerequisites first',''); return; }
    const btn=document.getElementById('ai-assum-btn'); btn.disabled=true; btn.textContent='Analyzing...';
    const prereqList = G.prereqs.map(p => `- ${p.text}`).join('\n');
    const existingAssums = G.assums.map(a => a.text).join(', ') || 'None yet';
    const sys=`You are an expert at surfacing hidden assumptions. Given a list of goals/prerequisites, identify 3-5 HIDDEN assumptions that people typically don't realize they're making. Focus on:
- Resource assumptions (time, money, people)
- Technical assumptions (systems work, integrations exist)
- Environmental assumptions (market conditions, regulations)
- Human assumptions (skills, availability, motivation)
Return ONLY a JSON array of objects with "text" (the assumption) and "prereq" (which prerequisite it relates to most, exact match from list).`;
    const res = await askClaude(sys, `Prerequisites:\n${prereqList}\n\nExisting assumptions: ${existingAssums}\n\nWhat hidden assumptions underlie these?`);
    btn.disabled=false; btn.textContent='‚ú® AI Surface Hidden';
    if(!res) return;
    try {
        const assumptions = JSON.parse(res.replace(/```json\n?|\n?```/g, ''));
        assumptions.forEach(a => {
            const newA = {id:G.id(),text:a.text,trigger:'monthly',status:'active',at:new Date()};
            G.assums.push(newA);
            const linkedPrereq = G.prereqs.find(p => p.text === a.prereq || p.text.includes(a.prereq) || a.prereq.includes(p.text));
            if(linkedPrereq) G.link('assum',newA.id,'prereq',linkedPrereq.id,'underlies');
        });
        G.save(); update();
        toast('Assumptions Surfaced', assumptions.length + ' hidden assumptions found');
    } catch(e) { toast('Parse Error', ''); console.log(res); }
}
function breakA(id) { const a=G.assums.find(x=>x.id===id); a.status='broken'; G.linked('assum',id).forEach(l=>{if(l.t==='prereq')l.item.status='blocked';}); G.save(); update(); toast('Assumption broken','Prerequisites blocked'); }
function renderAssums() { const c=document.getElementById('assum-list'); if(!G.assums.length){ c.innerHTML='<div class="empty"><div class="empty-icon">‚óá</div><div class="empty-title">No assumptions</div></div>'; return; } const trs={monthly:'‚è±',event:'üéØ',threshold:'üìä'}; c.innerHTML=G.assums.map(a=>{ const lks=G.linked('assum',a.id).map(l=>`<span class="link-tag">‚¨° ${trunc(l.item.text,10)}</span>`).join(''); return `<div class="list-item assumption"><div class="list-icon">‚óá</div><div class="list-content"><div class="list-text">${a.text}</div><div class="list-meta"><span>${trs[a.trigger]} ${a.trigger}</span><span>${a.status}</span></div>${lks?`<div class="list-links">${lks}</div>`:''}</div><div class="list-actions"><button class="btn btn-ghost" onclick="breakA('${a.id}')">Break</button><button class="btn btn-ghost" onclick="delAssum('${a.id}')" style="color:var(--accent-resurrector)">√ó</button></div></div>`; }).join(''); }

function delAssum(id) { G.assums = G.assums.filter(a=>a.id!==id); G.conns = G.conns.filter(c=>!(c.ft==='assum'&&c.fi===id)&&!(c.tt==='assum'&&c.ti===id)); G.save(); update(); toast('Deleted',''); }

// Handover
let customQs = [];
function renderQ() { const allQs = [...Qs, ...customQs]; const q=allQs[qIdx % allQs.length]; document.getElementById('q-text').textContent='"'+q.q+'"'; document.getElementById('q-ctx').textContent=q.c; document.getElementById('q-num').textContent='Q'+(qIdx+1)+'/'+allQs.length; }
function nextQ() { const allQs = [...Qs, ...customQs]; qIdx=(qIdx+1)%allQs.length; renderQ(); }
function saveKnowledge() { const t=document.getElementById('know-in').value.trim(); if(!t)return; const lk=document.getElementById('know-link').value; const allQs = [...Qs, ...customQs]; const k={id:G.id(),text:t,q:allQs[qIdx % allQs.length].q,at:new Date()}; G.knows.push(k); if(lk) G.link('know',k.id,'prereq',lk,'informs'); G.save(); document.getElementById('know-in').value=''; nextQ(); update(); toast('Knowledge saved',''); }
function renderKnows() { const c=document.getElementById('know-list'); if(!G.knows.length){ c.innerHTML='<div class="empty"><div class="empty-icon">‚áÑ</div><div class="empty-title">No knowledge</div></div>'; return; } c.innerHTML=G.knows.map(k=>`<div class="list-item knowledge"><div class="list-icon">‚áÑ</div><div class="list-content"><div class="list-text">${k.text}</div><div class="list-meta"><span>Q: ${trunc(k.q,20)}</span></div></div><div class="list-actions"><button class="btn btn-ghost" onclick="delKnow('${k.id}')" style="color:var(--accent-resurrector)">√ó</button></div></div>`).join(''); }

function delKnow(id) { G.knows = G.knows.filter(k=>k.id!==id); G.conns = G.conns.filter(c=>!(c.ft==='know'&&c.fi===id)&&!(c.tt==='know'&&c.ti===id)); G.save(); update(); toast('Deleted',''); }

async function aiGenerateQuestions() {
    const btn=document.getElementById('ai-q-btn'); btn.disabled=true; btn.textContent='Generating...';
    const prereqCtx = G.prereqs.length ? G.prereqs.map(p => p.text).join(', ') : 'General project';
    const existingKnowledge = G.knows.map(k => k.text).join('; ') || 'None captured yet';
    const sys=`You are an expert at knowledge extraction and handover interviews. Generate 4-6 probing questions that would extract tacit knowledge from someone leaving a project. Questions should uncover:
- Undocumented decisions and their reasoning
- Workarounds and gotchas
- Key relationships and dependencies
- Emergency procedures
- Things that "just work" but nobody knows why
Return ONLY a JSON array of objects with "q" (question) and "c" (what it captures, 2-3 words).`;
    const res = await askClaude(sys, `Project context: ${prereqCtx}\nAlready captured: ${existingKnowledge}\n\nGenerate contextual handover questions.`);
    btn.disabled=false; btn.textContent='‚ú® AI Questions';
    if(!res) return;
    try {
        customQs = JSON.parse(res.replace(/```json\n?|\n?```/g, ''));
        qIdx = Qs.length; // Jump to first custom question
        renderQ(); update();
        toast('Questions Generated', customQs.length + ' custom questions added');
    } catch(e) { toast('Parse Error', ''); console.log(res); }
}

// Constraints
function setDomain(d) { cLevel=5; document.getElementById('c-text').textContent='"'+Cs[d][0]+'"'; document.getElementById('c-level').textContent='Level 5'; document.getElementById('domain-pick').style.display='none'; document.getElementById('constraint-active').style.display='block'; dropdowns(); startTimer(180); }
function startTimer(s) { if(timer)clearInterval(timer); let r=s; timer=setInterval(()=>{ r--; document.getElementById('c-timer').textContent=Math.floor(r/60)+':'+(r%60).toString().padStart(2,'0'); document.getElementById('c-bar').style.width=(r/s*100)+'%'; if(r<=0)clearInterval(timer); },1000); }
function updateWords() { const t=document.getElementById('c-output').value; document.getElementById('word-ct').textContent=(t.trim()?t.trim().split(/\s+/).length:0)+' words'; }
function submitC() { if(cLevel>1){ cLevel--; document.getElementById('c-level').textContent='Level '+cLevel; startTimer(180+(5-cLevel)*60); toast('Released','Level '+cLevel); } }
function suggestFrag() { if(G.frags.length){ const f=G.frags[Math.floor(Math.random()*G.frags.length)]; document.getElementById('c-frag').value=f.id; toast('Fragment suggested',''); } }
function resetC() { document.getElementById('domain-pick').style.display='block'; document.getElementById('constraint-active').style.display='none'; document.getElementById('c-output').value=''; document.getElementById('ai-feedback').style.display='none'; if(timer)clearInterval(timer); }

async function aiEvaluateWork() {
    const work = document.getElementById('c-output').value.trim();
    const constraint = document.getElementById('c-text').textContent;
    if(!work){ toast('Write something first',''); return; }
    const btn=document.getElementById('ai-eval-btn'); btn.disabled=true; btn.textContent='Evaluating...';
    const sys=`You are a creative writing coach evaluating work against a specific constraint. Be encouraging but honest. Provide:
1. Does it meet the constraint? (Yes/Partially/No)
2. What works well (1 sentence)
3. One specific improvement suggestion
Keep response under 80 words. Be direct and helpful.`;
    const res = await askClaude(sys, `Constraint: ${constraint}\n\nWork submitted:\n"${work}"\n\nEvaluate this work.`);
    btn.disabled=false; btn.textContent='‚ú® AI Evaluate';
    if(!res) return;
    const fb = document.getElementById('ai-feedback');
    fb.innerHTML = `<div class="suggestion-title">AI Feedback</div><div class="suggestion-text">${res}</div>`;
    fb.style.display = 'block';
}

// Collision
function genCollision() { const ch=document.getElementById('coll-challenge').value.trim(); if(!ch)return; document.getElementById('coll-yours').textContent=ch.split(' ').slice(0,3).join(' '); document.getElementById('coll-random').textContent=RDs[Math.floor(Math.random()*RDs.length)]; document.getElementById('coll-result').style.display='block'; }
function saveCollision() { const cn=document.getElementById('coll-conn').value.trim(); if(!cn)return; const lk=document.getElementById('coll-link').value; const c={id:G.id(),yours:document.getElementById('coll-yours').textContent,random:document.getElementById('coll-random').textContent,conn:cn,at:new Date()}; G.colls.push(c); if(lk) G.link('coll',c.id,'prereq',lk,'inspires'); G.save(); document.getElementById('coll-conn').value=''; update(); toast('Collision saved',''); }

async function aiFindConnection() {
    const yours = document.getElementById('coll-yours').textContent;
    const random = document.getElementById('coll-random').textContent;
    const challenge = document.getElementById('coll-challenge').value.trim();
    if(yours === '‚Äî' || !random){ toast('Generate a collision first',''); return; }
    const btn=document.getElementById('ai-coll-btn'); btn.disabled=true; btn.textContent='Thinking...';
    const sys=`You are a creative thinker who finds unexpected connections between unrelated domains. Given two domains, find 2-3 surprising but useful connections. Be specific and actionable, not abstract. Focus on:
- Structural similarities (how things are organized)
- Process parallels (how things work)
- Metaphorical bridges (what one teaches about the other)
Keep each connection to 1-2 sentences. Be creative but practical.`;
    const res = await askClaude(sys, `Challenge: ${challenge}\n\nDomain 1: ${yours}\nDomain 2: ${random}\n\nWhat surprising connections can you find that might help solve the challenge?`);
    btn.disabled=false; btn.textContent='‚ú® AI Find Connection';
    if(!res) return;
    document.getElementById('coll-conn').value = res;
    toast('Connections Found', 'Review and save');
}
function renderColls() { const c=document.getElementById('coll-list'); if(!G.colls.length){ c.innerHTML='<div class="empty"><div class="empty-icon">‚úß</div><div class="empty-title">No collisions</div></div>'; return; } c.innerHTML=G.colls.map(x=>`<div class="list-item collision"><div class="list-icon">‚úß</div><div class="list-content"><div class="list-text">${x.conn}</div><div class="list-meta"><span>${x.yours} √ó ${x.random}</span></div></div><div class="list-actions"><button class="btn btn-ghost" onclick="delColl('${x.id}')" style="color:var(--accent-resurrector)">√ó</button></div></div>`).join(''); }

function delColl(id) { G.colls = G.colls.filter(c=>c.id!==id); G.conns = G.conns.filter(c=>!(c.ft==='coll'&&c.fi===id)&&!(c.tt==='coll'&&c.ti===id)); G.save(); update(); toast('Deleted',''); }

// Fragments
function saveFrag() { const t=document.getElementById('frag-in').value.trim(); if(!t)return; G.frags.push({id:G.id(),text:t,start:document.getElementById('frag-start').value,stop:document.getElementById('frag-stop').value,tags:document.getElementById('frag-tags').value.split(',').map(x=>x.trim()).filter(x=>x),at:new Date()}); G.save(); document.getElementById('frag-in').value=''; document.getElementById('frag-start').value=''; document.getElementById('frag-stop').value=''; document.getElementById('frag-tags').value=''; update(); toast('Fragment archived',''); }
function renderFrags() { const c=document.getElementById('frag-list'); if(!G.frags.length){ c.innerHTML='<div class="empty"><div class="empty-icon">‚Üª</div><div class="empty-title">No fragments</div></div>'; return; } c.innerHTML=G.frags.map(f=>{ const tags=f.tags.map(t=>`<span class="link-tag">${t}</span>`).join(''); return `<div class="list-item fragment"><div class="list-icon">‚Üª</div><div class="list-content"><div class="list-text">${trunc(f.text,80)}</div><div class="list-meta"><span>Start: ${f.start||'?'}</span><span>Stop: ${f.stop||'?'}</span></div>${tags?`<div class="list-links">${tags}</div>`:''}</div><div class="list-actions"><button class="btn btn-ghost" onclick="aiReviveFrag('${f.id}')">‚ú®</button><button class="btn btn-ghost" onclick="useFrag('${f.id}')">Use</button><button class="btn btn-ghost" onclick="delFrag('${f.id}')" style="color:var(--accent-resurrector)">√ó</button></div></div>`; }).join(''); }

function delFrag(id) { G.frags = G.frags.filter(f=>f.id!==id); G.save(); update(); toast('Deleted',''); }
function useFrag(id) { switchMode('collision'); setTimeout(()=>document.getElementById('coll-frag').value=id,100); }

async function aiAnalyzeFragment() {
    const text = document.getElementById('frag-in').value.trim();
    if(!text){ toast('Enter a fragment first',''); return; }
    const btn=document.getElementById('ai-frag-btn'); btn.disabled=true; btn.textContent='Analyzing...';
    const sys=`You are an expert at analyzing abandoned creative work. Given a fragment, identify:
1. What type of work this is (essay, story, code, idea, etc.)
2. Why it might have stalled (2-3 words)
3. 3-5 relevant tags for categorization
Return ONLY a JSON object with "type", "stalled_reason", and "tags" (array).`;
    const res = await askClaude(sys, `Analyze this fragment:\n\n"${text}"`);
    btn.disabled=false; btn.textContent='‚ú® AI Analyze & Tag';
    if(!res) return;
    try {
        const analysis = JSON.parse(res.replace(/```json\n?|\n?```/g, ''));
        document.getElementById('frag-start').value = analysis.type || '';
        document.getElementById('frag-stop').value = analysis.stalled_reason || '';
        document.getElementById('frag-tags').value = (analysis.tags || []).join(', ');
        toast('Analyzed', 'Review and archive');
    } catch(e) { toast('Parse Error', ''); console.log(res); }
}

async function aiReviveFrag(id) {
    const f = G.frags.find(x=>x.id===id);
    if(!f) return;
    toast('Thinking...', 'How to revive this');
    const prereqCtx = G.prereqs.length ? 'Current goals: ' + G.prereqs.filter(p=>p.level===0).map(p=>p.text).join(', ') : '';
    const sys=`You are a creative coach helping resurrect abandoned work. Given a fragment and why it stalled, suggest 2-3 specific, actionable ways to continue or repurpose it. Be practical and encouraging. Keep response under 100 words.`;
    const res = await askClaude(sys, `Fragment: "${trunc(f.text, 200)}"\n\nStarted because: ${f.start || 'Unknown'}\nStopped because: ${f.stop || 'Unknown'}\nTags: ${f.tags.join(', ') || 'None'}\n\n${prereqCtx}\n\nHow can this be revived or repurposed?`);
    if(!res) return;
    alert('Revival Ideas:\n\n' + res);
}

// Inverse
function addAnti() { const t=document.getElementById('anti-in').value.trim(); if(!t)return; const lk=document.getElementById('anti-link').value; const a={id:G.id(),text:t,at:new Date()}; G.antis.push(a); if(lk) G.link('anti',a.id,'prereq',lk,'constrains'); G.save(); document.getElementById('anti-in').value=''; update(); toast('Anti-goal added',''); }
function delAnti(id) { G.antis=G.antis.filter(a=>a.id!==id); G.conns=G.conns.filter(c=>!(c.ft==='anti'&&c.fi===id)&&!(c.tt==='anti'&&c.ti===id)); G.save(); update(); }

async function aiSuggestAntiGoals() {
    if(!G.prereqs.length){ toast('Add prerequisites first',''); return; }
    const btn=document.getElementById('ai-anti-btn'); btn.disabled=true; btn.textContent='Thinking...';
    const prereqList = G.prereqs.map(p => p.text).join(', ');
    const existingAntis = G.antis.map(a => a.text).join(', ') || 'None yet';
    const sys=`You are an expert at inverse thinking - defining what must NOT happen to clarify what should. Given goals/prerequisites, suggest 4-5 anti-goals that would:
- Protect quality (what corners must not be cut)
- Preserve values (what principles must not be violated)
- Avoid common failure modes
- Distinguish from competitors/alternatives
Return ONLY a JSON array of strings.`;
    const res = await askClaude(sys, `Goals/Prerequisites: ${prereqList}\n\nExisting anti-goals: ${existingAntis}\n\nWhat must NOT happen?`);
    btn.disabled=false; btn.textContent='‚ú® AI Suggest';
    if(!res) return;
    try {
        const antis = JSON.parse(res.replace(/```json\n?|\n?```/g, ''));
        antis.forEach(a => G.antis.push({id:G.id(),text:a,at:new Date()}));
        G.save(); update();
        toast('Anti-goals Added', antis.length + ' suggestions');
    } catch(e) { toast('Parse Error', ''); console.log(res); }
}

async function aiMapPossibilities() {
    if(G.antis.length < 2){ toast('Add more anti-goals','Need at least 2'); return; }
    const btn=document.getElementById('ai-poss-btn'); btn.disabled=true; btn.textContent='Mapping...';
    const antiList = G.antis.map(a => '- Must NOT: ' + a.text).join('\n');
    const prereqCtx = G.prereqs.length ? 'Goals: ' + G.prereqs.filter(p=>p.level===0).map(p=>p.text).join(', ') : '';
    const sys=`You are a strategic thinker who maps possibility spaces. Given a set of anti-goals (what must NOT happen), derive:
1. The positive space that remains (what IS possible)
2. 3-4 specific solution directions that respect all constraints
3. One unexpected approach that emerges from the constraints
Be specific and actionable. Format with clear headers.`;
    const res = await askClaude(sys, `${prereqCtx}\n\nAnti-goals:\n${antiList}\n\nMap the possibility space.`);
    btn.disabled=false; btn.textContent='‚ú® AI Map';
    if(!res) return;
    const ct = document.getElementById('poss-content');
    ct.innerHTML = `<div style="white-space:pre-wrap;font-size:12px;line-height:1.5;color:var(--text-secondary)">${res}</div>`;
    document.getElementById('poss-space').style.display = 'block';
    toast('Possibilities Mapped', '');
}
function renderAntis() { const c=document.getElementById('anti-list'); if(!G.antis.length){ c.innerHTML='<div class="empty"><div class="empty-icon">‚äò</div><div class="empty-title">No anti-goals</div></div>'; return; } c.innerHTML=G.antis.map(a=>{ const lks=G.linked('anti',a.id).map(l=>`<span class="link-tag">‚¨° ${trunc(l.item.text,10)}</span>`).join(''); return `<div class="list-item antigoal"><div class="list-icon">‚úï</div><div class="list-content"><div class="list-text">${a.text}</div>${lks?`<div class="list-links">${lks}</div>`:''}</div><div class="list-actions"><button class="btn btn-ghost" onclick="delAnti('${a.id}')">√ó</button></div></div>`; }).join(''); }
function updatePoss() { const c=document.getElementById('poss-space'); const ct=document.getElementById('poss-content'); if(G.antis.length<2){ c.style.display='none'; return; } c.style.display='block'; const inv=G.antis.map(a=>{ let t=a.text; if(t.toLowerCase().includes('must not'))t=t.replace(/must not/i,'must'); else if(t.toLowerCase().includes('no '))t=t.replace(/no /i,''); else if(t.toLowerCase().includes("don't"))t=t.replace(/don't/i,'do'); else t='NOT: '+t; return t; }); ct.innerHTML=`<p style="color:var(--text-secondary);margin-bottom:10px">Given ${G.antis.length} anti-goals, solution must:</p><ul style="padding-left:16px;line-height:1.6">${inv.map(i=>`<li>${i}</li>`).join('')}</ul>`; }

// Graph
function renderGraph() { document.getElementById('g-prereq').textContent=G.prereqs.length; document.getElementById('g-assum').textContent=G.assums.length; document.getElementById('g-frag').textContent=G.frags.length; document.getElementById('g-conn').textContent=G.conns.length; const c=document.getElementById('conn-list'); if(!G.conns.length){ c.innerHTML='<div class="empty"><div class="empty-icon">‚óà</div><div class="empty-title">No connections</div></div>'; return; } c.innerHTML=G.conns.map(cn=>{ const f=G[cn.ft+'s']?.find(x=>x.id===cn.fi); const t=G[cn.tt+'s']?.find(x=>x.id===cn.ti); if(!f||!t)return''; return `<div class="list-item"><div class="list-content"><div class="list-text"><strong>${cn.ft}</strong> ‚Üí <strong>${cn.tt}</strong> ${cn.l?'('+cn.l+')':''}</div><div class="list-meta"><span>${trunc(f.text||f.conn,20)}</span><span>‚Üí</span><span>${trunc(t.text,20)}</span></div></div></div>`; }).filter(x=>x).join(''); }

// Suggestions
function renderSugg() { const c=document.getElementById('suggestions'); const s=[]; const noA=G.prereqs.filter(p=>!G.conns.some(cn=>(cn.tt==='prereq'&&cn.ti===p.id&&cn.ft==='assum'))); if(noA.length&&mode==='prerequisite') s.push({t:'Surface Assumptions',x:noA.length+' prereq(s) without assumptions'}); if(G.frags.length&&mode==='constraint') s.push({t:'Use Fragment',x:G.frags.length+' fragment(s) available'}); if(G.antis.length>=3&&mode==='inverse') s.push({t:'Map Possibility',x:'Enough anti-goals to derive space'}); c.innerHTML=s.map(x=>`<div class="suggestion"><div class="suggestion-title">üí° ${x.t}</div><div class="suggestion-text">${x.x}</div></div>`).join(''); }

// Activity
function renderAct() { const c=document.getElementById('activity'); const all=[ ...G.prereqs.map(p=>({t:'prerequisite',i:p,d:new Date(p.at)})), ...G.assums.map(a=>({t:'assumption',i:a,d:new Date(a.at)})), ...G.knows.map(k=>({t:'knowledge',i:k,d:new Date(k.at)})), ...G.frags.map(f=>({t:'fragment',i:f,d:new Date(f.at)})), ...G.colls.map(x=>({t:'collision',i:x,d:new Date(x.at)})), ...G.antis.map(a=>({t:'antigoal',i:a,d:new Date(a.at)})) ].sort((a,b)=>b.d-a.d).slice(0,5); if(!all.length){ c.innerHTML='<div class="empty" style="padding:16px"><div class="empty-text">No activity</div></div>'; return; } const icons={prerequisite:'‚¨°',assumption:'‚óá',knowledge:'‚áÑ',fragment:'‚Üª',collision:'‚úß',antigoal:'‚äò'}; c.innerHTML=all.map(a=>`<div class="activity-card ${a.t}"><div class="activity-type">${icons[a.t]} ${a.t}</div><div class="activity-text">${trunc(a.i.text||a.i.conn||'',40)}</div><div class="activity-meta">${timeAgo(a.d)}</div></div>`).join(''); }

// ========== TOUR ==========
const tourSteps = [
    { target: '.logo', title: 'Welcome to Berta1Clarity', text: 'A thinking tool powered by Claude AI. It helps you break down goals, surface hidden assumptions, and think more clearly.', pos: 'right' },
    { target: '[data-mode="prerequisite"]', title: 'Prerequisites', text: 'Start here. Enter your goal and click "AI Decompose" to break it into 3-5 things that must be true first. Keep expanding until you hit actionable items.', pos: 'right' },
    { target: '[data-mode="assumption"]', title: 'Assumptions', text: 'Hidden beliefs can derail projects. Click "AI Surface Hidden" to find assumptions you didn\'t know you were making.', pos: 'right' },
    { target: '[data-mode="handover"]', title: 'Handover', text: 'Extract tacit knowledge before it disappears. AI generates interview questions to capture what\'s undocumented.', pos: 'right' },
    { target: '[data-mode="constraint"]', title: 'Constraints', text: 'Creativity under pressure. Pick a domain, get a constraint, write against the clock. AI evaluates your work.', pos: 'right' },
    { target: '[data-mode="collision"]', title: 'Collisions', text: 'Spark original ideas. Your challenge meets a random domain. AI finds unexpected connections between them.', pos: 'right' },
    { target: '[data-mode="resurrector"]', title: 'Fragments', text: 'Abandoned drafts waiting for their moment. Archive them here, and AI will suggest how to revive them later.', pos: 'right' },
    { target: '[data-mode="inverse"]', title: 'Inverse Brief', text: 'Define what must NOT happen. AI maps the remaining possibility space - often more original than starting positive.', pos: 'right' },
    { target: '[data-mode="graph"]', title: 'Clarity Graph', text: 'See everything connected. Prerequisites, assumptions, anti-goals - all linked together.', pos: 'right' },
    { target: '.right', title: 'Live Sidebar', text: 'Track your progress in real-time. See recent activity, connections, and AI suggestions as you work.', pos: 'left' }
];

let tourIdx = 0;

function startTour() {
    tourIdx = 0;
    document.getElementById('tour-overlay').classList.add('active');
    renderTourStep();
}

function endTour() {
    document.getElementById('tour-overlay').classList.remove('active');
    toast('Tour ended', 'Explore on your own!');
}

function nextTourStep() {
    if (tourIdx < tourSteps.length - 1) { tourIdx++; renderTourStep(); }
    else { endTour(); }
}

function prevTourStep() {
    if (tourIdx > 0) { tourIdx--; renderTourStep(); }
}

function renderTourStep() {
    const step = tourSteps[tourIdx];
    const target = document.querySelector(step.target);
    const highlight = document.getElementById('tour-highlight');
    const tooltip = document.getElementById('tour-tooltip');

    // Position highlight and clone content
    if (target) {
        const rect = target.getBoundingClientRect();
        highlight.style.top = (rect.top - 4) + 'px';
        highlight.style.left = (rect.left - 4) + 'px';
        highlight.style.width = (rect.width + 8) + 'px';
        highlight.style.height = (rect.height + 8) + 'px';

        // Clone the element content into highlight
        const clone = target.cloneNode(true);
        clone.style.margin = '4px';
        clone.style.width = rect.width + 'px';
        clone.style.height = rect.height + 'px';
        highlight.innerHTML = '';
        highlight.appendChild(clone);

        // Position tooltip
        const tooltipWidth = 320;
        if (step.pos === 'right') {
            tooltip.style.top = Math.max(20, rect.top) + 'px';
            tooltip.style.left = (rect.right + 20) + 'px';
            tooltip.style.right = 'auto';
        } else {
            tooltip.style.top = Math.max(20, rect.top) + 'px';
            tooltip.style.right = (window.innerWidth - rect.left + 20) + 'px';
            tooltip.style.left = 'auto';
        }
    }

    // Update content
    document.getElementById('tour-step-num').textContent = `Step ${tourIdx + 1} of ${tourSteps.length}`;
    document.getElementById('tour-title').textContent = step.title;
    document.getElementById('tour-text').textContent = step.text;

    // Update dots
    document.getElementById('tour-dots').innerHTML = tourSteps.map((_, i) =>
        `<div class="tour-dot ${i === tourIdx ? 'active' : ''}"></div>`
    ).join('');

    // Update buttons
    document.getElementById('tour-prev').style.display = tourIdx === 0 ? 'none' : 'inline-flex';
    document.getElementById('tour-next').textContent = tourIdx === tourSteps.length - 1 ? 'Finish' : 'Next';
}

// ========== DEMO DATA ==========
function loadDemo() {
    if (G.prereqs.length > 0 && !confirm('This will replace your current data. Continue?')) return;

    // Clear existing
    G.prereqs = []; G.assums = []; G.knows = []; G.frags = []; G.colls = []; G.antis = []; G.conns = [];

    const now = new Date();
    const id = () => G.id();

    // Demo prerequisites
    const goalId = id();
    G.prereqs.push({id: goalId, text: 'Launch AI-powered customer support chatbot by Q2', level: 0, status: 'in-progress', pid: null, at: now});

    const p1 = id(), p2 = id(), p3 = id(), p4 = id();
    G.prereqs.push({id: p1, text: 'NLP model trained on company knowledge base', level: 1, status: 'complete', pid: goalId, at: now});
    G.prereqs.push({id: p2, text: 'Integration with existing ticketing system', level: 1, status: 'in-progress', pid: goalId, at: now});
    G.prereqs.push({id: p3, text: 'Escalation workflow to human agents defined', level: 1, status: '', pid: goalId, at: now});
    G.prereqs.push({id: p4, text: 'Security review and compliance approval', level: 1, status: 'blocked', pid: goalId, at: now});

    const p1a = id(), p1b = id();
    G.prereqs.push({id: p1a, text: 'Clean and structure 2 years of support tickets', level: 2, status: 'complete', pid: p1, at: now});
    G.prereqs.push({id: p1b, text: 'Fine-tune base model on domain vocabulary', level: 2, status: 'complete', pid: p1, at: now});

    // Demo assumptions
    const a1 = id(), a2 = id(), a3 = id();
    G.assums.push({id: a1, text: 'Response time under 3 seconds is acceptable to users', trigger: 'threshold', status: 'active', at: now});
    G.assums.push({id: a2, text: 'Legal team will approve data processing within 2 weeks', trigger: 'event', status: 'active', at: now});
    G.assums.push({id: a3, text: 'Existing API can handle 10x current load', trigger: 'monthly', status: 'active', at: now});

    G.link('assum', a1, 'prereq', p2, 'underlies');
    G.link('assum', a2, 'prereq', p4, 'underlies');

    // Demo knowledge
    G.knows.push({id: id(), text: 'The legacy ticketing system has an undocumented rate limit of 100 requests/minute', q: 'What would surprise your replacement?', at: now});
    G.knows.push({id: id(), text: 'Customer complaints spike on Monday mornings - schedule maintenance for weekends', q: 'What do you check first when something goes wrong?', at: now});

    // Demo fragments
    G.frags.push({id: id(), text: 'Draft proposal for proactive support - reaching out before customers complain based on usage patterns...', start: 'Excited about innovation', stop: 'Resource constraints', tags: ['proposal', 'proactive', 'ml'], at: now});

    // Demo collisions
    G.colls.push({id: id(), yours: 'customer support', random: 'Beekeeping', conn: 'Like bees communicating through dance, support tickets contain patterns. The "waggle dance" of frequent keywords could predict issues before they escalate.', at: now});

    // Demo anti-goals
    const anti1 = id(), anti2 = id(), anti3 = id();
    G.antis.push({id: anti1, text: 'Must not require customers to repeat information they already provided', at: now});
    G.antis.push({id: anti2, text: 'Must not feel robotic or scripted', at: now});
    G.antis.push({id: anti3, text: 'Must not create more work for human agents', at: now});

    G.link('anti', anti1, 'prereq', p2, 'constrains');

    G.save();
    update();
    switchMode('prerequisite');
    toast('Demo Loaded', 'Explore the example data');
}

// ========== CLEAR ALL DATA ==========
function clearAllData() {
    if (!confirm('Delete ALL data? This cannot be undone.')) return;
    G.prereqs = []; G.assums = []; G.knows = []; G.frags = []; G.colls = []; G.antis = []; G.conns = [];
    G.save();
    update();
    toast('Cleared', 'All data deleted');
}

// ========== EXPORT FUNCTIONS ==========

function buildPrereqTree(pid = null, indent = '') {
    const children = G.prereqs.filter(p => p.pid === pid);
    let md = '';
    children.forEach(p => {
        const status = p.status === 'complete' ? '‚úì' : p.status === 'blocked' ? '‚úó' : p.status === 'in-progress' ? '‚óê' : '‚óã';
        md += `${indent}- ${status} ${p.text}\n`;
        md += buildPrereqTree(p.id, indent + '  ');
    });
    return md;
}

function exportMarkdown() {
    if (!G.prereqs.length && !G.assums.length && !G.antis.length) {
        toast('No data', 'Add some content first');
        return;
    }

    const goals = G.prereqs.filter(p => p.level === 0).map(p => p.text).join(', ') || 'Untitled';
    let md = `# Berta1Clarity Report\n\n`;
    md += `**Generated:** ${new Date().toLocaleString()}\n\n`;
    md += `**Goals:** ${goals}\n\n`;
    md += `---\n\n`;

    // Prerequisites
    if (G.prereqs.length) {
        md += `## Prerequisites\n\n`;
        md += buildPrereqTree(null);
        md += `\n`;
    }

    // Assumptions
    if (G.assums.length) {
        md += `## Assumptions\n\n`;
        G.assums.forEach(a => {
            md += `- **${a.status}** (${a.trigger}): ${a.text}\n`;
        });
        md += `\n`;
    }

    // Knowledge
    if (G.knows.length) {
        md += `## Captured Knowledge\n\n`;
        G.knows.forEach(k => {
            md += `- ${k.text}\n  - *Q: ${k.q}*\n`;
        });
        md += `\n`;
    }

    // Anti-goals
    if (G.antis.length) {
        md += `## Anti-Goals (Must NOT)\n\n`;
        G.antis.forEach(a => {
            md += `- ‚úó ${a.text}\n`;
        });
        md += `\n`;
    }

    // Collisions
    if (G.colls.length) {
        md += `## Collisions & Insights\n\n`;
        G.colls.forEach(c => {
            md += `### ${c.yours} √ó ${c.random}\n`;
            md += `${c.conn}\n\n`;
        });
    }

    // Fragments
    if (G.frags.length) {
        md += `## Fragments (Archived)\n\n`;
        G.frags.forEach(f => {
            md += `### ${f.tags.join(', ') || 'Untagged'}\n`;
            md += `${f.text}\n`;
            md += `*Started: ${f.start || '?'} | Stopped: ${f.stop || '?'}*\n\n`;
        });
    }

    // Download
    const blob = new Blob([md], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clarity-report-${new Date().toISOString().split('T')[0]}.md`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Downloaded', 'Markdown file saved');
}

function exportJSON() {
    const data = { prereqs: G.prereqs, assums: G.assums, knows: G.knows, frags: G.frags, colls: G.colls, antis: G.antis, conns: G.conns, exported: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clarity-data-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Downloaded', 'JSON file saved');
}

async function generateAISummary() {
    if (!G.prereqs.length) { toast('No data', 'Add prerequisites first'); return; }

    const btn = document.getElementById('ai-summary-btn');
    btn.disabled = true; btn.textContent = 'Generating report...';

    // Build context
    const goals = G.prereqs.filter(p => p.level === 0).map(p => p.text).join('; ');
    const prereqs = G.prereqs.map(p => `${'  '.repeat(p.level)}[${p.status || 'pending'}] ${p.text}`).join('\n');
    const assumptions = G.assums.map(a => `- [${a.status}] ${a.text}`).join('\n') || 'None logged';
    const antigoals = G.antis.map(a => `- ${a.text}`).join('\n') || 'None defined';
    const knowledge = G.knows.map(k => `- ${k.text}`).join('\n') || 'None captured';
    const collisions = G.colls.map(c => `${c.yours} √ó ${c.random}: ${c.conn}`).join('\n') || 'None';

    const sys = `You are a strategic advisor analyzing a project planning session. Generate a comprehensive executive brief that includes:

1. **Executive Summary** (2-3 sentences)
2. **Goal Analysis** - What they're trying to achieve and why it matters
3. **Critical Path** - The most important prerequisites to focus on
4. **Risk Assessment** - Based on assumptions and blocked items
5. **Blind Spots** - What might they be missing?
6. **Strategic Recommendations** - 3-5 actionable next steps
7. **Anti-Pattern Analysis** - How the anti-goals shape the solution space

Be specific, actionable, and reference their actual content. Write in a professional but accessible tone.`;

    const prompt = `PROJECT ANALYSIS REQUEST

GOALS:
${goals}

PREREQUISITE TREE:
${prereqs}

ASSUMPTIONS:
${assumptions}

ANTI-GOALS (Must NOT):
${antigoals}

CAPTURED KNOWLEDGE:
${knowledge}

CREATIVE COLLISIONS:
${collisions}

Generate a strategic brief analyzing this project.`;

    const res = await askClaude(sys, prompt, 2000);
    btn.disabled = false; btn.textContent = '‚ú® Generate AI Summary';

    if (res) {
        document.getElementById('ai-summary-content').textContent = res;
        document.getElementById('ai-summary-result').style.display = 'block';
        toast('Report Generated', 'Review below');
    }
}

function copyAISummary() {
    const text = document.getElementById('ai-summary-content').textContent;
    navigator.clipboard.writeText(text);
    toast('Copied', 'Report copied to clipboard');
}

function generateVisualReport() {
    if (!G.prereqs.length) { toast('No data', 'Add prerequisites first'); return; }

    const goals = G.prereqs.filter(p => p.level === 0).map(p => p.text).join(', ');

    let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Berta1Clarity Report - ${goals}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; color: #1a1a1a; line-height: 1.6; }
        h1 { font-size: 28px; margin-bottom: 8px; }
        .subtitle { color: #666; font-size: 14px; margin-bottom: 32px; }
        h2 { font-size: 18px; color: #333; margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 2px solid #e8c547; }
        h3 { font-size: 14px; color: #666; margin: 16px 0 8px; }
        .prereq { padding: 8px 12px; margin: 4px 0; background: #f5f5f5; border-radius: 6px; border-left: 3px solid #7dd3fc; }
        .prereq.complete { border-left-color: #4ade80; }
        .prereq.blocked { border-left-color: #f87171; }
        .prereq.in-progress { border-left-color: #fb923c; }
        .l1 { margin-left: 20px; } .l2 { margin-left: 40px; } .l3 { margin-left: 60px; }
        .assumption { padding: 8px 12px; margin: 4px 0; background: #fdf2f8; border-radius: 6px; border-left: 3px solid #f472b6; }
        .antigoal { padding: 8px 12px; margin: 4px 0; background: #eff6ff; border-radius: 6px; border-left: 3px solid #60a5fa; }
        .knowledge { padding: 8px 12px; margin: 4px 0; background: #f5f3ff; border-radius: 6px; border-left: 3px solid #a78bfa; }
        .collision { padding: 12px; margin: 8px 0; background: #f0fdf4; border-radius: 6px; border-left: 3px solid #4ade80; }
        .collision-header { font-weight: 600; color: #166534; margin-bottom: 4px; }
        .status { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        .status.complete { background: #dcfce7; color: #166534; }
        .status.blocked { background: #fee2e2; color: #991b1b; }
        .status.in-progress { background: #ffedd5; color: #9a3412; }
        .status.active { background: #fdf2f8; color: #9d174d; }
        .meta { font-size: 12px; color: #666; margin-top: 4px; }
        .footer { margin-top: 48px; padding-top: 16px; border-top: 1px solid #eee; font-size: 12px; color: #999; text-align: center; }
        @media print { body { padding: 20px; } }
    </style>
</head>
<body>
    <h1>Berta1Clarity Report</h1>
    <div class="subtitle">Generated ${new Date().toLocaleString()} | Goals: ${goals}</div>
`;

    // Prerequisites
    if (G.prereqs.length) {
        html += `<h2>Prerequisites</h2>`;
        G.prereqs.forEach(p => {
            const statusClass = p.status || '';
            const statusLabel = p.status ? `<span class="status ${p.status}">${p.status}</span>` : '';
            html += `<div class="prereq ${statusClass} l${p.level}">${p.text}${statusLabel}</div>`;
        });
    }

    // Assumptions
    if (G.assums.length) {
        html += `<h2>Assumptions</h2>`;
        G.assums.forEach(a => {
            html += `<div class="assumption">${a.text}<span class="status ${a.status}">${a.status}</span><div class="meta">Trigger: ${a.trigger}</div></div>`;
        });
    }

    // Anti-goals
    if (G.antis.length) {
        html += `<h2>Anti-Goals</h2>`;
        G.antis.forEach(a => {
            html += `<div class="antigoal">‚úó ${a.text}</div>`;
        });
    }

    // Knowledge
    if (G.knows.length) {
        html += `<h2>Captured Knowledge</h2>`;
        G.knows.forEach(k => {
            html += `<div class="knowledge">${k.text}<div class="meta">Q: ${k.q}</div></div>`;
        });
    }

    // Collisions
    if (G.colls.length) {
        html += `<h2>Creative Collisions</h2>`;
        G.colls.forEach(c => {
            html += `<div class="collision"><div class="collision-header">${c.yours} √ó ${c.random}</div>${c.conn}</div>`;
        });
    }

    html += `
    <div class="footer">
        Generated by Berta1Clarity | Think once. Build right.
    </div>
</body>
</html>`;

    // Open in new tab
    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
    toast('Report Generated', 'Print to save as PDF');
}

// ========== SETTINGS FUNCTIONS ==========
function initSettings() {
    // Load saved values into form
    document.getElementById('ai-provider').value = AI_CONFIG.provider;
    document.getElementById('anthropic-key').value = AI_CONFIG.anthropic.key;
    document.getElementById('anthropic-model').value = AI_CONFIG.anthropic.model;
    document.getElementById('openai-key').value = AI_CONFIG.openai.key;
    document.getElementById('openai-model').value = AI_CONFIG.openai.model;
    document.getElementById('google-key').value = AI_CONFIG.google.key;
    document.getElementById('google-model').value = AI_CONFIG.google.model;
    updateProviderStatus();
}

function updateProvider(provider) {
    AI_CONFIG.provider = provider;
    saveAIConfig();
    updateProviderStatus();
    toast('Provider Updated', provider.charAt(0).toUpperCase() + provider.slice(1));
}

function saveKey(provider) {
    AI_CONFIG[provider].key = document.getElementById(provider + '-key').value;
    AI_CONFIG[provider].model = document.getElementById(provider + '-model').value;
    saveAIConfig();
    updateProviderStatus();
}

function updateProviderStatus() {
    const provider = AI_CONFIG.provider;
    const config = AI_CONFIG[provider];
    const status = document.getElementById('provider-status');

    if (config.key) {
        status.innerHTML = `<span style="color:var(--accent-collision)">‚úì ${provider.charAt(0).toUpperCase() + provider.slice(1)} configured</span> ‚Äî Using ${config.model}`;
        status.style.background = 'rgba(74,222,128,0.1)';
    } else {
        status.innerHTML = `<span style="color:var(--accent-resurrector)">‚úó No API key set</span> ‚Äî Add your ${provider} key below`;
        status.style.background = 'rgba(248,113,113,0.1)';
    }
}

async function testAIConnection() {
    const btn = document.getElementById('test-ai-btn');
    const result = document.getElementById('test-result');

    btn.disabled = true;
    btn.textContent = 'Testing...';
    result.style.display = 'none';

    const response = await askClaude(
        'You are a helpful assistant. Respond with a single short sentence confirming the connection works.',
        'Say "Connection successful!" and mention which AI model you are.'
    );

    btn.disabled = false;
    btn.textContent = 'üîå Test AI Connection';
    result.style.display = 'block';

    if (response) {
        result.innerHTML = `<div style="padding:10px;background:rgba(74,222,128,0.1);border-radius:6px;color:var(--accent-collision)">‚úì ${response}</div>`;
    } else {
        result.innerHTML = `<div style="padding:10px;background:rgba(248,113,113,0.1);border-radius:6px;color:var(--accent-resurrector)">‚úó Connection failed. Check your API key.</div>`;
    }
}

// Initialize settings on load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initSettings, 100);
});

// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
            .then(reg => console.log('Berta1Clarity: Service Worker registered', reg.scope))
            .catch(err => console.log('Berta1Clarity: Service Worker failed', err));
    });
}
</script>
</body>
</html>
